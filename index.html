<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les Boucles de Lydie</title>

    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        .modal-open { overflow: hidden; }
        #product-modal { transition: opacity 0.3s ease; }
        .zoom-container { overflow: hidden; border-radius: 1.5rem; background: #f9fafb; position: relative; }
        .zoom-container img { transition: transform 0.3s ease; cursor: zoom-in; }
        @media (hover: hover) { .zoom-container img:hover { transform: scale(1.5); } }
        .zoom-container img:active { transform: scale(1.8); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="admin-bar" class="hidden bg-black text-white p-2 text-center text-[10px] gap-4 sticky top-0 z-[60]">
        <a href="/admin/index.html" class="font-bold underline">ðŸ“¦ GÃ‰RER STOCK</a> | 
        <a href="/admin/admin-commandes.html" class="font-bold underline">ðŸ“‹ COMMANDES</a>
    </div>

    <nav class="bg-white shadow-sm p-4 sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-xl font-bold text-pink-600 italic">Les Boucles de Lydie</h1>
        <div class="flex items-center gap-2">
            <a href="/mes-commandes.html" id="btn-mes-commandes" class="hidden relative text-[10px] bg-pink-100 text-pink-600 px-3 py-2 rounded font-bold uppercase transition hover:bg-pink-200">
                ðŸ“‹ Mes Commandes
                <span id="dot-notif" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 border-2 border-white rounded-full"></span>
            </a>
            <button onclick="netlifyIdentity.open()" id="auth-btn" class="text-[10px] bg-gray-100 px-3 py-2 rounded font-bold uppercase">ðŸ‘¤ Connexion</button>
            <a href="/panier.html" class="relative p-2 bg-pink-100 rounded-full">
                ðŸ›’ <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">0</span>
            </a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 mb-20">
        <div id="produits-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <p class="col-span-full text-center py-20 italic text-gray-400">Chargement de la collection...</p>
        </div>
    </main>

    <div id="product-modal" class="fixed inset-0 z-[100] hidden bg-black/70 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-white w-full max-w-lg rounded-t-[40px] md:rounded-[40px] overflow-hidden shadow-2xl relative animate-slide-up">
            <button onclick="closeModal()" class="absolute top-6 right-6 z-10 bg-white/90 backdrop-blur-md p-2 rounded-full shadow-lg text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="p-3">
                <div class="zoom-container aspect-square">
                    <div id="modal-badge" class="absolute top-4 left-4 z-10"></div>
                    <img id="modal-img" src="" alt="" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400?text=Image+indisponible'">
                </div>
            </div>
            <div class="p-8">
                <h2 id="modal-title" class="text-2xl font-black text-gray-800 mb-1"></h2>
                <div class="flex justify-between items-center mb-4">
                    <p id="modal-price" class="text-xl font-bold text-pink-500"></p>
                    <p id="modal-stock-info" class="text-[10px] font-bold uppercase"></p>
                </div>
                <p id="modal-desc" class="text-gray-500 text-sm leading-relaxed mb-8 italic"></p>
                <button id="modal-add-btn" class="w-full py-4 rounded-2xl font-black uppercase tracking-widest transition-all">
                    Ajouter au panier
                </button>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://rsebvgdneetbbmdchwil.supabase.co", "sb_publishable_c_U9tbQzawyqAVuLTEYWWA_XBW6Fbs6");
        let panier = [];
        try {
            const stored = localStorage.getItem('panier');
            panier = stored ? JSON.parse(stored) : [];
        } catch(e) { panier = []; }
        
        let allProducts = [];

        document.addEventListener('DOMContentLoaded', () => { 
            chargerBoutique(); 
            updateCartCount(); 
            incrementerVisiteur();
        });

        netlifyIdentity.on('init', user => { if (user) handleAuth(user); });
        netlifyIdentity.on('login', user => { handleAuth(user); netlifyIdentity.close(); });
        netlifyIdentity.on('logout', () => { location.reload(); });

        function handleAuth(user) {
            if (!user) return;
            if (user.email.toLowerCase() === "lydie90@wanadoo.fr") document.getElementById('admin-bar').classList.remove('hidden');
            document.getElementById('btn-mes-commandes').classList.remove('hidden');
            document.getElementById('auth-btn').innerText = "ðŸ‘¤ DÃ©connexion";
            verifierNotifications(user.email);
        }

        async function incrementerVisiteur() {
            try {
                if (!sessionStorage.getItem('visite_comptabilisee')) {
                    const { data: current } = await _supabase
                        .from('statistiques')
                        .select('valeur')
                        .eq('nom', 'visiteurs')
                        .maybeSingle();
                    
                    if (current) {
                        await _supabase
                            .from('statistiques')
                            .update({ valeur: parseInt(current.valeur) + 1 })
                            .eq('nom', 'visiteurs');
                        
                        sessionStorage.setItem('visite_comptabilisee', 'true');
                    }
                }
            } catch (e) { console.error("Erreur compteur:", e); }
        }

        async function verifierNotifications(email) {
            try {
                const { data } = await _supabase.from('commande').select('id').eq('statut', 'ValidÃ©e').or(`client_email.eq."${email}",contenu.ilike."%${email}%"`).limit(1);
                if (data && data.length > 0) document.getElementById('dot-notif').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        async function chargerBoutique() {
            const container = document.getElementById('produits-container');
            try {
                const { data, error } = await _supabase.from('produits').select('*').order('id', { ascending: false });
                if (error) throw error;
                allProducts = data;

                container.innerHTML = data.map(p => {
                    const isOut = (p.stock <= 0);
                    return `
                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full hover:shadow-md transition relative overflow-hidden">
                        ${p.badge ? `<div class="absolute top-4 left-4 z-10 bg-pink-500 text-white text-[8px] font-black px-2 py-1 rounded-md uppercase shadow-md">${p.badge}</div>` : ''}
                        
                        <img src="${p.image}" onclick="openProduct(${p.id})" 
                             onerror="this.src='https://via.placeholder.com/300?text=Image+Indisponible'"
                             class="w-full h-44 object-cover rounded-xl mb-2 cursor-pointer ${isOut ? 'grayscale opacity-50' : ''}">
                        
                        <h4 onclick="openProduct(${p.id})" class="font-bold text-[12px] mb-1 cursor-pointer line-clamp-1">${p.titre}</h4>
                        
                        <p class="text-[9px] mb-2 ${isOut ? 'text-red-500 font-bold' : 'text-gray-400 font-medium'}">
                            ${isOut ? 'ðŸš« Victime de son succÃ¨s' : `En stock : ${p.stock}`}
                        </p>

                        <p class="text-pink-600 font-black text-lg mb-3">${parseFloat(p.prix).toFixed(2)} â‚¬</p>
                        
                        <button onclick="ajouterAuPanier(${p.id}, event)" 
                            ${isOut ? 'disabled' : ''}
                            class="w-full py-2.5 rounded-xl text-[11px] font-bold uppercase transition-all active:scale-95 ${isOut ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-pink-500 text-white shadow-lg shadow-pink-100'}">
                            ${isOut ? 'Ã‰puisÃ©' : 'Ajouter'}
                        </button>
                    </div>`;
                }).join('');
            } catch (err) { container.innerHTML = "<p class='col-span-full text-center py-10 text-red-400'>Erreur de chargement.</p>"; }
        }

        function openProduct(id) {
            const p = allProducts.find(item => item.id == id);
            if (!p) return;
            const isOut = p.stock <= 0;

            document.getElementById('modal-img').src = p.image;
            document.getElementById('modal-title').innerText = p.titre;
            document.getElementById('modal-price').innerText = `${parseFloat(p.prix).toFixed(2)} â‚¬`;
            document.getElementById('modal-desc').innerText = p.description || "CrÃ©ation artisanale unique. âœ¨";
            
            const mBadge = document.getElementById('modal-badge');
            mBadge.innerHTML = p.badge ? `<span class="bg-pink-500 text-white text-[10px] font-black px-3 py-1.5 rounded-lg uppercase shadow-lg">${p.badge}</span>` : '';

            const sInfo = document.getElementById('modal-stock-info');
            sInfo.innerText = isOut ? "BientÃ´t de retour" : `Disponible : ${p.stock}`;
            sInfo.className = `text-[10px] font-bold uppercase ${isOut ? 'text-red-500' : 'text-green-500'}`;

            const btn = document.getElementById('modal-add-btn');
            if(isOut) {
                btn.innerText = "Produit Ã‰puisÃ©";
                btn.disabled = true;
                btn.className = "w-full bg-gray-100 text-gray-400 py-4 rounded-2xl font-black uppercase cursor-not-allowed";
                btn.onclick = null;
            } else {
                btn.innerText = "Ajouter au panier";
                btn.disabled = false;
                btn.className = "w-full bg-pink-500 text-white py-4 rounded-2xl font-black uppercase shadow-xl shadow-pink-200 active:scale-95";
                btn.onclick = (e) => { ajouterAuPanier(p.id, e); closeModal(); };
            }

            document.getElementById('product-modal').classList.remove('hidden');
            document.body.classList.add('modal-open');
        }

        function closeModal() { document.getElementById('product-modal').classList.add('hidden'); document.body.classList.remove('modal-open'); }

        function ajouterAuPanier(id, event) { 
            const p = allProducts.find(item => item.id == id);
            if (!p || p.stock <= 0) return alert("DÃ©solÃ©, ce bijou n'est plus disponible.");

            const article = {
                titre: String(p.titre || "Bijou").trim(),
                prix: parseFloat(p.prix) || 0
            };

            panier.push(article); 
            localStorage.setItem('panier', JSON.stringify(panier));
            updateCartCount();

            const btn = event ? event.target.closest('button') : null;
            if (btn) {
                const originalText = btn.innerText;
                btn.innerText = "âœ… AJOUTÃ‰"; 
                btn.classList.add('!bg-green-500');
                setTimeout(() => { 
                    btn.innerText = originalText; 
                    btn.classList.remove('!bg-green-500'); 
                }, 800);
            }
        }

        function updateCartCount() { document.getElementById('cart-count').innerText = panier.length; }
    </script>
</body>
</html>
