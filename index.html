<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les Boucles de Lydie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="admin-bar" class="hidden bg-black text-white p-2 text-center text-[10px] gap-4 sticky top-0 z-[60]">
        <a href="/admin/index.html" class="font-bold underline">ðŸ“¦ GÃ‰RER STOCK</a> | 
        <a href="/admin/admin-commandes.html" class="font-bold underline">ðŸ“‹ COMMANDES</a>
    </div>

    <nav class="bg-white shadow-sm p-4 sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-xl font-bold text-pink-600 italic">Les Boucles de Lydie</h1>
        <div class="flex items-center gap-2">
            <a href="/mes-commandes.html" id="btn-mes-commandes" class="hidden relative text-[10px] bg-pink-100 text-pink-600 px-3 py-2 rounded font-bold uppercase transition hover:bg-pink-200">
                ðŸ“‹ Mes Commandes
                <span id="dot-notif" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 border-2 border-white rounded-full"></span>
            </a>
            
            <button onclick="netlifyIdentity.open()" id="auth-btn" class="text-[10px] bg-gray-100 px-3 py-2 rounded font-bold uppercase">ðŸ‘¤ Connexion</button>
            
            <a href="/panier.html" class="relative p-2 bg-pink-100 rounded-full">
                ðŸ›’ <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">0</span>
            </a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 mb-20">
        <div id="produits-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <p class="col-span-full text-center py-20 italic text-gray-400">Chargement de la collection...</p>
        </div>
    </main>

    <a href="https://wa.me/33673460409" target="_blank" class="fixed bottom-5 left-5 bg-[#25d366] text-white px-5 py-3 rounded-full z-[100] font-bold shadow-lg flex items-center gap-2">
        ðŸ’¬ WhatsApp
    </a>

    <script>
        const _supabase = supabase.createClient("https://rsebvgdneetbbmdchwil.supabase.co", "sb_publishable_c_U9tbQzawyqAVuLTEYWWA_XBW6Fbs6");
        
        let panier = JSON.parse(localStorage.getItem('panier')) || [];

        // Lancer la boutique au dÃ©marrage
        document.addEventListener('DOMContentLoaded', () => {
            chargerBoutique();
            updateCartCount();
        });

        // Gestion Netlify Identity
        netlifyIdentity.on('init', user => { if (user) handleAuth(user); });
        netlifyIdentity.on('login', user => { handleAuth(user); netlifyIdentity.close(); });
        netlifyIdentity.on('logout', () => { location.reload(); });

        function handleAuth(user) {
            if (!user) return;

            // Admin Lydie
            if (user.email.toLowerCase() === "lydie90@wanadoo.fr") {
                document.getElementById('admin-bar').classList.remove('hidden');
            }
            
            // Client
            document.getElementById('btn-mes-commandes').classList.remove('hidden');
            document.getElementById('auth-btn').innerText = "ðŸ‘¤ DÃ©connexion";
            
            // VÃ©rification des notifications (Table: commande)
            verifierNotifications(user.email);
        }

        async function verifierNotifications(email) {
            try {
                // Utilisation du nom exact : 'commande' (sans s)
                const { data } = await _supabase
                    .from('commande')
                    .select('id')
                    .eq('statut', 'ValidÃ©e')
                    .or(`client_email.eq."${email}",contenu.ilike."%${email}%"`)
                    .limit(1);
                
                if (data && data.length > 0) {
                    document.getElementById('dot-notif').classList.remove('hidden');
                }
            } catch (e) { console.error("Erreur notif:", e); }
        }

        async function chargerBoutique() {
            const container = document.getElementById('produits-container');
            try {
                const { data, error } = await _supabase.from('produits').select('*').order('id', { ascending: false });
                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = "<p class='col-span-full text-center py-20 italic text-gray-400'>La collection arrive bientÃ´t...</p>";
                    return;
                }

                container.innerHTML = data.map(p => `
                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full hover:shadow-md transition">
                        <img src="${p.image}" class="w-full h-44 object-cover rounded-xl mb-2" onerror="this.src='https://via.placeholder.com/200'">
                        <h4 class="font-bold text-[12px] mb-1">${p.titre}</h4>
                        <p class="text-pink-600 font-black text-lg mb-3">${parseFloat(p.prix).toFixed(2)} â‚¬</p>
                        <button onclick="ajouterAuPanier('${p.titre.replace(/'/g, "\\'")}', ${p.prix}, '${p.image}')" class="bg-pink-500 text-white py-2.5 rounded-xl text-[11px] font-bold uppercase active:scale-95 transition-all">
                            Ajouter
                        </button>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = "<p class='col-span-full text-center py-10 text-red-400'>Erreur de chargement des produits.</p>";
            }
        }

        function ajouterAuPanier(titre, prix, image) { 
            panier.push({ titre, prix, image }); 
            localStorage.setItem('panier', JSON.stringify(panier));
            updateCartCount();
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "âœ… AJOUTÃ‰";
            btn.classList.replace('bg-pink-500', 'bg-green-500');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.replace('bg-green-500', 'bg-pink-500');
            }, 1000);
        }

        function updateCartCount() {
            const countEl = document.getElementById('cart-count');
            if (countEl) countEl.innerText = panier.length;
        }
    </script>
</body>
</html>
