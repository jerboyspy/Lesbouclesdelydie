<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestion Commandes - Les Boucles de Lydie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>body { display: none; }</style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <nav class="bg-white shadow-sm p-3 sticky top-0 z-50 flex justify-between items-center">
        <span class="text-pink-600 font-bold text-sm">üíé Administration</span>
        <div class="flex gap-2">
            <a href="/admin/" class="bg-gray-800 text-white px-3 py-2 rounded-lg text-[10px] font-bold uppercase">üì¶ Stock</a>
            <a href="/" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg text-[10px] font-bold uppercase">üè† Site</a>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4">
        
        <div class="bg-white p-4 rounded-2xl shadow-sm mb-6 border border-pink-100">
            <h3 class="text-[10px] font-black uppercase text-pink-400 mb-3">R√©glages Livraison standard</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[9px] font-bold text-gray-400">Prix Port (‚Ç¨)</label>
                    <input type="number" id="global-port" value="4.50" step="0.1" class="w-full p-2 bg-gray-50 rounded-lg text-sm border-none ring-1 ring-gray-200">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-gray-400">Gratuit d√®s (‚Ç¨)</label>
                    <input type="number" id="global-seuil" value="50" class="w-full p-2 bg-gray-50 rounded-lg text-sm border-none ring-1 ring-gray-200">
                </div>
            </div>
        </div>

        <div id="liste-admin" class="space-y-4">
            <p class="text-center py-10 text-gray-400 italic">Chargement des commandes...</p>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://rsebvgdneetbbmdchwil.supabase.co", "sb_publishable_c_U9tbQzawyqAVuLTEYWWA_XBW6Fbs6");

        // VERIFICATION DE SECURITE STRICTE
        netlifyIdentity.on('init', user => {
            if (!user || user.email.toLowerCase() !== "lydie90@wanadoo.fr") {
                window.location.href = "/"; // Redirection si ce n'est pas toi
            } else {
                document.body.style.display = "block"; // Affiche la page
                chargerCommandes();
            }
        });

        // S√©curit√© en cas de d√©connexion
        netlifyIdentity.on('logout', () => window.location.href = "/");

        async function chargerCommandes() {
            const { data, error } = await _supabase.from('commande').select('*').order('created_at', { ascending: false });
            if (error) return;

            const container = document.getElementById('liste-admin');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center py-10 text-gray-400 italic">Aucune commande pour le moment.</p>';
                return;
            }

            container.innerHTML = data.map(c => `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <p class="font-bold text-gray-800 text-sm">${c.client_email}</p>
                        <span class="text-[9px] font-black px-2 py-1 rounded-full uppercase ${c.statut === 'Valid√©e' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">${c.statut}</span>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-xl text-[11px] text-gray-500 mb-4 whitespace-pre-wrap">${c.contenu}</div>

                    <div class="space-y-3 bg-pink-50/50 p-3 rounded-2xl border border-pink-100">
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] font-bold text-pink-400">PRIX BIJOUX (‚Ç¨)</label>
                            <input type="number" id="prix-bijoux-${c.id}" value="${c.total}" step="0.01" class="w-20 p-1 text-right rounded border-none bg-white text-sm font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] font-bold text-pink-400">FRAIS DE PORT (‚Ç¨)</label>
                            <input type="number" id="port-custom-${c.id}" value="${c.total >= document.getElementById('global-seuil').value ? 0 : document.getElementById('global-port').value}" step="0.1" class="w-20 p-1 text-right rounded border-none bg-white text-sm font-bold">
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button onclick="validerEtEnvoyer('${c.id}', '${c.client_email}')" class="flex-1 bg-green-500 text-white py-3 rounded-xl text-[10px] font-black uppercase shadow-md active:scale-95 transition">
                            ‚úÖ Valider & Envoyer Wero
                        </button>
                        <button onclick="supprimerCommande('${c.id}')" class="bg-gray-100 p-3 rounded-xl text-xs">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function validerEtEnvoyer(id, nom) {
            const prixB = parseFloat(document.getElementById(`prix-bijoux-${id}`).value);
            const prixP = parseFloat(document.getElementById(`port-custom-${id}`).value);
            const totalFinal = (prixB + prixP).toFixed(2);

            // Mise √† jour Supabase
            const { error } = await _supabase.from('commande').update({ 
                total: parseFloat(totalFinal),
                statut: 'Valid√©e' 
            }).eq('id', id);

            if (!error) {
                const msg = `Coucou ${nom} ! C'est bon pour moi, le stock est valid√© ‚úÖ.\n\nMontant bijoux : ${prixB.toFixed(2)}‚Ç¨\nFrais de port : ${prixP === 0 ? 'OFFERT' : prixP.toFixed(2)+'‚Ç¨'}\nTOTAL : ${totalFinal}‚Ç¨\n\nTu peux effectuer ton virement Wero sur mon num√©ro. Merci ! üå∏`;
                window.location.href = `https://wa.me/33673460409?text=${encodeURIComponent(msg)}`;
                chargerCommandes();
            } else {
                alert("Erreur lors de la mise √† jour : " + error.message);
            }
        }

        async function supprimerCommande(id) {
            if (confirm("Supprimer d√©finitivement cette commande ?")) {
                const { error } = await _supabase.from('commande').delete().eq('id', id);
                if (!error) chargerCommandes();
            }
        }
    </script>
</body>
</html>
