<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Les Boucles de Lydie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="bg-gray-50 p-4 pb-20 text-gray-800 font-sans">
    <div class="max-w-lg mx-auto">
        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8 border border-pink-100 text-center">
            <h2 class="text-2xl font-black text-pink-600 mb-6 italic">Espace Admin Lydie</h2>
            
            <form id="produit-form" class="space-y-4 text-left">
                <input type="text" id="titre" class="w-full p-4 bg-gray-100 rounded-2xl border-none" placeholder="Nom du bijou" required>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" step="0.01" id="prix" class="w-full p-4 bg-gray-100 rounded-2xl border-none" placeholder="Prix (â‚¬)" required>
                    <input type="number" id="stock" class="w-full p-4 bg-gray-100 rounded-2xl border-none" placeholder="Stock" required>
                </div>
                <div class="bg-pink-50 p-5 rounded-2xl border-2 border-dashed border-pink-200">
                    <input type="file" id="fileInput" accept="image/*" class="text-xs">
                </div>
                <button type="submit" id="btn-submit" class="w-full bg-pink-500 text-white py-5 rounded-2xl font-black uppercase shadow-lg">ğŸš€ Mettre en ligne</button>
            </form>
        </div>
        <div id="produits-list" class="space-y-3"></div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://rsebvgdneetbbmdchwil.supabase.co", "sb_publishable_c_U9tbQzawyqAVuLTEYWWA_XBW6Fbs6");

        netlifyIdentity.on('init', user => { 
            if (!user) window.location.href = "/"; 
            chargerListe(); 
        });

        document.getElementById('produit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const file = document.getElementById('fileInput').files[0];
            
            if(!file) return alert("Veuillez choisir une photo !");

            btn.disabled = true;
            btn.innerText = "â³ ENVOI EN COURS...";

            try {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64Content = reader.result.split(',')[1];
                    const fileName = `img_${Date.now()}.${file.name.split('.').pop()}`;

                    // On appelle la Netlify Function qu'on vient de crÃ©er
                    const res = await fetch('/.netlify/functions/upload', {
                        method: 'POST',
                        body: JSON.stringify({ fileName, content: base64Content })
                    });

                    if(!res.ok) throw new Error("Erreur lors de l'envoi de la photo.");

                    const uploadData = await res.json();

                    // On enregistre dans Supabase avec le lien de l'image
                    const { error } = await _supabase.from('produits').insert([{
                        titre: document.getElementById('titre').value,
                        prix: parseFloat(document.getElementById('prix').value),
                        stock: parseInt(document.getElementById('stock').value),
                        image: uploadData.url
                    }]);

                    if (error) throw error;
                    
                    alert("Bijou ajoutÃ© avec succÃ¨s !");
                    location.reload();
                };
            } catch (err) {
                alert("Erreur : " + err.message);
                btn.disabled = false;
                btn.innerText = "ğŸš€ Mettre en ligne";
            }
        });

        async function chargerListe() {
            const { data } = await _supabase.from('produits').select('*').order('id', { ascending: false });
            document.getElementById('produits-list').innerHTML = data ? data.map(p => `
                <div class="flex items-center justify-between p-3 bg-white rounded-2xl shadow-sm border">
                    <div class="flex items-center gap-3">
                        <img src="${p.image}" class="w-12 h-12 rounded-xl object-cover">
                        <span class="text-xs font-bold">${p.titre}</span>
                    </div>
                    <button onclick="supprimer(${p.id})" class="text-red-400 p-2">ğŸ—‘ï¸</button>
                </div>
            `).join('') : '';
        }

        async function supprimer(id) {
            if(confirm("Supprimer ?")) {
                await _supabase.from('produits').delete().eq('id', id);
                chargerListe();
            }
        }
    </script>
</body>
</html>
